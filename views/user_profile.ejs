<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Switter</title>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noty/3.1.4/noty.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">Switter</a>
            <div class="navbar-nav">
                <a href="/" class="nav-link">Home</a>
                <a href="/all-users" class="nav-link">Users</a>
                <a href="/chat" class="nav-link">Chat</a>
                <a href="/social-graph" class="nav-link">Graph</a>
                <a href="/notifications" class="nav-link">Notifications</a>
                <a href="/profile/<%= locals.user._id %>" class="nav-link active">Profile</a>
                <a href="/signout" class="btn btn-ghost btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <main class="container py-8">
        <div class="max-w-6xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Sidebar -->
                <div class="flex flex-col gap-6">
                    <!-- Profile Card -->
                    <div class="card">
                        <div class="card-content py-6 flex flex-col items-center text-center gap-4">
                            <div class="avatar avatar-xl">
                                <%if(profile_user.avatar){%>
                                    <img src="<%=profile_user.avatar%>" alt="<%=profile_user.name%>" class="avatar-image">
                                <%}else{%>
                                    <div class="avatar-fallback text-2xl"><%=profile_user.name.charAt(0).toUpperCase()%></div>
                                <%}%>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold"><%=profile_user.name%></h2>
                                <p class="text-sm text-muted"><%=profile_user.email%></p>
                            </div>
                            
                            <%if(locals.user && locals.user._id.toString() !== profile_user._id.toString()){%>
                                <% 
                                    let isFriend = locals.user.friends && locals.user.friends.some(f => f._id.toString() === profile_user._id.toString());
                                    let requestSent = locals.user.sentRequests && locals.user.sentRequests.some(r => r._id.toString() === profile_user._id.toString());
                                    let requestReceived = locals.user.friendRequests && locals.user.friendRequests.some(r => r._id.toString() === profile_user._id.toString());
                                %>
                                <%if(isFriend){%>
                                    <div class="flex flex-col gap-2 w-full">
                                        <span class="badge badge-default">Friends</span>
                                        <form action="/friends/remove-friend" method="POST">
                                            <input type="hidden" name="friendId" value="<%=profile_user._id%>">
                                            <button type="submit" class="btn btn-destructive w-full">Unfriend</button>
                                        </form>
                                    </div>
                                <%}else if(requestSent){%>
                                    <span class="badge badge-secondary">Request Sent</span>
                                <%}else if(requestReceived){%>
                                    <form action="/friends/accept-request" method="POST" class="w-full">
                                        <input type="hidden" name="friendId" value="<%=profile_user._id%>">
                                        <button type="submit" class="btn btn-primary w-full">Accept Request</button>
                                    </form>
                                <%}else{%>
                                    <form action="/friends/send-request" method="POST" class="w-full">
                                        <input type="hidden" name="friendId" value="<%=profile_user._id%>">
                                        <button type="submit" class="btn btn-primary w-full">Add Friend</button>
                                    </form>
                                <%}%>
                            <%}%>
                            
                            <%if(locals.user && locals.user._id.toString() === profile_user._id.toString()){%>
                                <div class="flex flex-col gap-2 w-full">
                                    <a href="/update-Information" class="btn btn-outline w-full">Edit Profile</a>
                                    <a href="/social-graph" class="btn btn-secondary w-full">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <circle cx="12" cy="12" r="4"></circle>
                                            <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line>
                                            <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line>
                                        </svg>
                                        Social Graph
                                    </a>
                                </div>
                            <%}%>
                        </div>
                    </div>

                    <!-- Friends Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Friends</h3>
                            <p class="card-description"><%=profile_user.friends ? profile_user.friends.length : 0%> friends</p>
                        </div>
                        <div class="card-content">
                            <%if(profile_user.friends && profile_user.friends.length > 0){%>
                                <div class="flex flex-col gap-2">
                                    <%for(let friend of profile_user.friends.slice(0, 5)){%>
                                        <a href="/profile/<%=friend._id%>" class="flex items-center gap-3 p-2 rounded hover:bg-accent">
                                            <div class="avatar avatar-sm">
                                                <%if(friend.avatar){%>
                                                    <img src="<%=friend.avatar%>" alt="<%=friend.name%>" class="avatar-image">
                                                <%}else{%>
                                                    <div class="avatar-fallback"><%=friend.name.charAt(0).toUpperCase()%></div>
                                                <%}%>
                                            </div>
                                            <span class="text-sm font-medium"><%=friend.name%></span>
                                        </a>
                                    <%}%>
                                    <%if(profile_user.friends.length > 5){%>
                                        <p class="text-sm text-muted text-center">+<%=profile_user.friends.length - 5%> more</p>
                                    <%}%>
                                </div>
                            <%}else{%>
                                <p class="text-sm text-muted text-center py-4">No friends yet</p>
                            <%}%>
                        </div>
                    </div>

                    <!-- Friend Requests -->
                    <%if(locals.user && profile_user.friendRequests && profile_user.friendRequests.length > 0 && locals.user._id.toString() === profile_user._id.toString()){%>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Friend Requests</h3>
                            <p class="card-description"><%=profile_user.friendRequests.length%> pending</p>
                        </div>
                        <div class="card-content">
                            <div class="flex flex-col gap-3">
                                <%for(let request of profile_user.friendRequests){%>
                                    <div class="flex items-center gap-3">
                                        <div class="avatar avatar-sm">
                                            <%if(request.avatar){%>
                                                <img src="<%=request.avatar%>" alt="<%=request.name%>" class="avatar-image">
                                            <%}else{%>
                                                <div class="avatar-fallback"><%=request.name.charAt(0).toUpperCase()%></div>
                                            <%}%>
                                        </div>
                                        <div class="flex-1">
                                            <a href="/profile/<%=request._id%>" class="text-sm font-medium hover:underline"><%=request.name%></a>
                                        </div>
                                        <div class="flex gap-1">
                                            <form action="/friends/accept-request" method="POST" style="display:inline;">
                                                <input type="hidden" name="friendId" value="<%=request._id%>">
                                                <button type="submit" class="btn btn-primary btn-sm">Accept</button>
                                            </form>
                                            <form action="/friends/reject-request" method="POST" style="display:inline;">
                                                <input type="hidden" name="friendId" value="<%=request._id%>">
                                                <button type="submit" class="btn btn-ghost btn-sm">Reject</button>
                                            </form>
                                        </div>
                                    </div>
                                <%}%>
                            </div>
                        </div>
                    </div>
                    <%}%>

                    <!-- Twitter Integration -->
                    <%if(locals.user && locals.user._id.toString() === profile_user._id.toString()){%>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Twitter Sync</h3>
                            <p class="card-description">Import your tweets as posts</p>
                        </div>
                        <div class="card-content">
                            <%if(profile_user.twitter && profile_user.twitter.connected){%>
                                <div class="flex flex-col gap-4">
                                    <div class="flex items-center gap-3 p-3 rounded" style="background-color: hsl(var(--muted));">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #1DA1F2;">
                                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                        </svg>
                                        <div class="flex-1">
                                            <p class="font-medium">Connected as @<%=profile_user.twitter.username%></p>
                                            <%if(profile_user.twitter.lastSync){%>
                                                <p class="text-sm text-muted">Last synced: <%=new Date(profile_user.twitter.lastSync).toLocaleDateString()%></p>
                                            <%}%>
                                        </div>
                                    </div>

                                    <button id="sync-tweets-btn" class="btn btn-primary w-full">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23 4 23 10 17 10"></polyline>
                                            <polyline points="1 20 1 14 7 14"></polyline>
                                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                        </svg>
                                        Sync Tweets
                                    </button>

                                    <form action="/twitter/disconnect" method="POST">
                                        <button type="submit" class="btn btn-outline w-full">Disconnect Twitter</button>
                                    </form>

                                    <div id="sync-status"></div>
                                </div>
                            <%}else{%>
                                <div class="flex flex-col gap-4">
                                    <p class="text-sm text-muted">Connect your Twitter account to import your tweets as posts on Switter.</p>
                                    <a href="/twitter/connect" class="btn btn-primary w-full">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                        </svg>
                                        Connect Twitter
                                    </a>
                                </div>
                            <%}%>
                        </div>
                    </div>
                    <%}%>
                </div>

                <!-- Main Content -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <%if(locals.user && (!profile_user || locals.user._id.toString() === profile_user._id.toString())){%>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Create Post</h3>
                        </div>
                        <div class="card-content">
                            <form action="/post/create" id="new-post-form" method="POST" class="flex flex-col gap-4">
                                <textarea name="content" class="textarea" placeholder="What's on your mind?" required rows="3"></textarea>
                                <button type="submit" class="btn btn-primary">Post</button>
                            </form>
                        </div>
                    </div>
                    <%}%>

                    <div class="flex flex-col gap-4">
                        <h3 class="text-xl font-semibold">Posts</h3>
                        <%if(posts.length === 0){%>
                            <div class="card">
                                <div class="card-content py-12 text-center">
                                    <p class="text-muted">No posts yet</p>
                                </div>
                            </div>
                        <%}else{%>
                            <%for(let post of posts){%>
                            <div class="card hover-lift">
                                <div class="card-header">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="avatar">
                                                <%if(post.user.avatar){%>
                                                    <img src="<%=post.user.avatar%>" alt="<%=post.user.name%>" class="avatar-image">
                                                <%}else{%>
                                                    <div class="avatar-fallback"><%=post.user.name.charAt(0).toUpperCase()%></div>
                                                <%}%>
                                            </div>
                                            <div>
                                                <h4 class="font-semibold"><%=post.user.name%></h4>
                                                <p class="text-sm text-muted"><%=new Date(post.createdAt).toLocaleDateString()%></p>
                                            </div>
                                        </div>
                                        <%if(locals.user && locals.user._id.toString() === post.user._id.toString()){%>
                                            <a href="/post/destroy/<%=post._id%>" class="btn btn-ghost btn-sm">Delete</a>
                                        <%}%>
                                    </div>
                                </div>
                                <div class="card-content">
                                    <p><%=post.content%></p>
                                </div>
                                <div class="card-footer">
                                    <%if(locals.user){%>
                                        <a class="toggle-like-button btn btn-ghost btn-sm" data-likes="<%=post.likes.length%>" href="/likes/toggle/?id=<%=post._id%>&type=Post">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                            </svg>
                                            <span><%=post.likes.length%></span>
                                        </a>
                                    <%}else{%>
                                        <span class="text-sm text-muted"><%=post.likes.length%> likes</span>
                                    <%}%>
                                </div>
                                <div class="separator"></div>
                                <div class="card-content">
                                    <%if(locals.user){%>
                                    <form action="/comments/create" method="post" class="flex gap-2 mb-4">
                                        <input type="text" name="content" class="input" placeholder="Write a comment..." required>
                                        <input type="hidden" name="post" value="<%=post._id%>">
                                        <button type="submit" class="btn btn-primary btn-sm">Comment</button>
                                    </form>
                                    <%}%>
                                    <%if(post.comment && post.comment.length > 0){%>
                                        <div class="flex flex-col gap-3">
                                            <%for(let comment of post.comment){%>
                                                <%if(comment.user){%>
                                                <div class="flex gap-3">
                                                    <div class="avatar avatar-sm">
                                                        <%if(comment.user.avatar){%>
                                                            <img src="<%=comment.user.avatar%>" alt="<%=comment.user.name%>" class="avatar-image">
                                                        <%}else{%>
                                                            <div class="avatar-fallback"><%=comment.user.name.charAt(0).toUpperCase()%></div>
                                                        <%}%>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="card">
                                                            <div class="card-content p-3">
                                                                <p class="font-semibold text-sm"><%=comment.user.name || 'Unknown User'%></p>
                                                                <p class="text-sm"><%=comment.content%></p>
                                                            </div>
                                                        </div>
                                                        <%if(locals.user && (locals.user._id.toString() === comment.user._id.toString() || locals.user._id.toString() === post.user._id.toString())){%>
                                                            <a href="/comments/destroy/<%=comment._id%>" class="text-sm text-muted hover:text-foreground">Delete</a>
                                                        <%}%>
                                                    </div>
                                                </div>
                                                <%}%>
                                            <%}%>
                                        </div>
                                    <%}%>
                                </div>
                            </div>
                            <%}%>
                        <%}%>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        <% if(flash.success && flash.success.length > 0){ %>
            new Noty({
                theme: 'relax',
                text: "<%=flash.success%>",
                type: "success",
                layout: "topRight",
                timeout: 1500
            }).show();
        <% } %>
        <% if(flash.error && flash.error.length > 0){ %>
            new Noty({
                theme: 'relax',
                text: "<%=flash.error%>",
                type: "error",
                layout: "topRight",
                timeout: 1500
            }).show();
        <% } %>

        document.querySelectorAll('.toggle-like-button').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                const url = button.getAttribute('href');
                try {
                    const response = await fetch(url, { method: 'POST' });
                    const data = await response.json();
                    if(data.success) {
                        button.querySelector('span').textContent = data.data.likes;
                    }
                } catch(err) {
                    console.error('Error:', err);
                }
            });
        });

        // Twitter sync functionality
        const syncBtn = document.getElementById('sync-tweets-btn');
        if(syncBtn) {
            syncBtn.addEventListener('click', async () => {
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<span class="spinner"></span> Syncing...';
                const statusDiv = document.getElementById('sync-status');
                
                try {
                    const response = await fetch('/twitter/sync', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    
                    if(data.success) {
                        statusDiv.innerHTML = '<div class="p-3 rounded" style="background-color: rgba(16, 185, 129, 0.1); color: #10b981;"><p class="text-sm font-medium">✓ ' + data.message + '</p></div>';
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        statusDiv.innerHTML = '<div class="p-3 rounded" style="background-color: rgba(239, 68, 68, 0.1); color: #ef4444;"><p class="text-sm font-medium">✗ ' + data.message + '</p></div>';
                        syncBtn.disabled = false;
                        syncBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Sync Tweets';
                    }
                } catch(err) {
                    statusDiv.innerHTML = '<div class="p-3 rounded" style="background-color: rgba(239, 68, 68, 0.1); color: #ef4444;"><p class="text-sm font-medium">✗ Error syncing tweets</p></div>';
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> Sync Tweets';
                }
            });
        }
    </script>
</body>
</html>
